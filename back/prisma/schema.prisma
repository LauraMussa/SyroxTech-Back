// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider     = "prisma-client"
  output       = "../generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

enum OrderStatus {
  PENDING
  PREPARING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PAID
  PENDING
  FAILED
}

model User {
  id        String     @id @default(uuid())
  email     String     @unique
  password  String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  name      String
  address   String?
  phone     String?
  auditLogs AuditLog[]

  @@map("users")
}

model Product {
  id          String     @id @default(uuid())
  name        String
  description String?    @db.Text
  price       Decimal    @db.Decimal(10, 2)
  stock       Int        @default(0)
  brand       String?
  gender      String?
  isActive    Boolean    @default(true)
  isDeleted   Boolean    @default(false)
  options     Json?
  categoryId  String
  category    Category   @relation(fields: [categoryId], references: [id])
  saleItems   SaleItem[]
  images      String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("products")
}

model Category {
  id       String     @id @default(uuid())
  name     String
  position Int        @default(0)
  parentId String?
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy") //subcategorias
  products Product[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("categories")
}

model Customer {
  id      String  @id @default(uuid())
  name    String
  email   String  @unique
  phone   String?
  address String?
  sales   Sale[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("customers")
}

model Sale {
  id              String        @id @default(uuid())
  orderNumber     String        @unique
  total           Decimal       @db.Decimal(20, 2)
  status          OrderStatus   @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)
  paymentMethod   String?
  trackingId      String?
  customerId      String
  customer        Customer      @relation(fields: [customerId], references: [id])
  shippingAddress String?
  note            String?
  items           SaleItem[]
  history         SaleHistory[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("sales")
}

model SaleItem {
  id        String  @id @default(uuid())
  quantity  Int
  price     Decimal @db.Decimal(10, 2)
  saleId    String
  sale      Sale    @relation(fields: [saleId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])

  @@map("sale_items")
}

model SaleHistory {
  id        String      @id @default(uuid())
  saleId    String
  sale      Sale        @relation(fields: [saleId], references: [id])
  status    OrderStatus
  note      String?
  changedBy String?
  createdAt DateTime    @default(now())

  @@map("sale_history")
}

model AuditLog {
  id          String   @id @default(uuid())
  action      String // Ej: "CREAR_PRODUCTO", "ACTUALIZAR_VENTA"
  description String // Ej: "Se creó el producto Nike Air Force"
  userId      String // El ID del usuario que hizo la acción
  user        User     @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())

  // Opcional: Si quieres guardar metadatos extra (ej: el precio anterior y el nuevo)
  metadata Json?
}
